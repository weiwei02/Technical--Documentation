---
title: -架构设计-应用可伸缩架构分析
date: 2017-08-09 14:51:24
tags:
- framework
- theory
categories:
- framework
author: 为为
avatar: /images/favicon.png
---
# 引言
  网站的伸缩性是指不需要改变服务器的硬件设计，仅仅靠改变应用服务器的部署数量，就可以扩大或缩小服务器的处理能力。一般来说，网站的伸缩性设计可分为两类，一类是根据功能进行物理分离实现伸缩，一类是单一功能通过集群实现伸缩。前者是不同服务器部署不同的服务，提供不同的功能。后者是集群中多台服务器部署相同的服务，提供相同的功能。

# 方法

## 依据功能实现伸缩
  从网站发展早期，通过增加服务器提高网站处理能力时，新增服务器总是从现有服务器中分离出部分功能和服务。
  ![通过物理实现服务器伸缩.jpg](https://weiwei02.coding.me/images/framework/flexible/通过物理实现服务器伸缩.jpg)
  图1 通过物理实现服务器伸缩

  图1所描述的伸缩性就是每次伸缩操作都会有更多的服务器加入网站，新增的服务器用于处理特定的服务。依据功能进行进行架构伸缩的具体实现方案有两种，纵向分离和横向分离。

  * __纵向分离__
  纵向分离是指服务根据业务流程上的不同部分分开进行部署，实现系统上的伸缩性，其分离方式如图2所示。
  ![纵向分离部署实现系统可伸缩性.jpg](https://weiwei02.coding.me/images/framework/flexible/纵向分离部署实现系统可伸缩性.jpg)
  图2 纵向分离部署实现系统可伸缩性

  * __横向分离__
  横向分离又称为业务分割，其实现方式是将不同的业务模块分离部署，实现可伸缩性，如图3所示。根据系统的性能要求可以将横向分离的力度做到非常小。
  ![横向分离.jpg](https://weiwei02.coding.me/images/framework/flexible/横向分离.jpg)
  图3 横向分离部署实现系统可伸缩性

## 通过集群实现伸缩
  将不同功能分离部署可以实现一定程度的伸缩性，但是随着网站访问量的逐步增加，即使分离到最小力度的独立部署，单一的服务器也不能满足业务规模的需求。此时可以使用服务器的集群，将相同的服务部署到多台服务器上构成一个集群整体对外提供服务。具体来说，集群伸缩性又可分为应用服务器集群伸缩性和数据服务器集群伸缩性。而数据服务集群也可分为缓存数据服务器集群和存储数据服务器集群。

## 应用服务器集群的伸缩性设计
  应用服务器应该被设计成无状态的，即应用服务器不存储请求上下文信息，如果将部署有相同应用的服务器组成一个集群，用户的每一个请求都可以发送到任意一台服务器上去处理，任何一台服务器处理的结果都是相同的。这样只要能将用户请求按照某种规则分发到集群的不同服务器上，就可以构成一个应用服务器集群，每个用户的请求都可能落在不同的服务器上。  
  如果HTTP请求分发装置可以感知或者可以配置集群服务器的数量，可以及时发现集群中新上线或下线的服务器，并能向新上线的服务器发送请求，停止向已下线的服务器分发请求，那么就实现了应用服务器的伸缩性。在这里，这个HTTP请求分发装置被称为负载均衡服务器。 使用负载均衡服务器实现应用服务器可伸缩架构如图4所示。
  ![负载均衡.jpg](https://weiwei02.coding.me/images/framework/flexible/负载均衡.jpg)
  图4 负载均衡实现系统可伸缩性

  负载均衡是大型网站必不可少的技术手段，不但可以实现网站的可伸缩性，同时还可以改善网络的可用性。负载均衡的具体实现也多种多样，可以使用专有硬件也可以使用软件来实现。

### HTTP重定向负载均衡
  利用HTTP重定向协议实现负载均衡，如图5所示。
  ![请求重定向.jpg](https://weiwei02.coding.me/images/framework/flexible/请求重定向.jpg)
  图5 HTTP请求重定向负载均衡原理

  HTTP重定向服务器时一台普通的WEB服务器，其唯一的功能就是根据用户的HTTP请求计算一台真实的WEB服务器地址，并将该WEB服务地址写入HTTP重定向响应中（响应状态码为302）返回给用户浏览器。这种负载均衡的优点是实现比较简单。缺点是浏览器需要两次请求服务器才能进行一次访问，性能较差。其次重定向服务器自身的处理能力有可能成为瓶颈，整个集群的伸缩性规模有限。再者使用HTTP302响应状态码重定向，有可能使搜索引擎判断为SEO作弊，降低搜索引擎排名。

### DNS域名解析负载均衡
  这是利用DNS进行域名解析请求时进行负载均衡处理的一种方案。每次域名解析请求都会根据负载均衡算法可能计算出一个不同的IP地址，以后该用户对网站的请求都发送到这个地址上。如图6所示。
  ![DNS域名解析.jpg](https://weiwei02.coding.me/images/framework/flexible/DNS域名解析.jpg)
  图6 DNS域名解析负载均衡原理

  在DNS服务器中配置多个A纪录，如： www.mysite.com IN A 10.0.0.1、www.mysite.com IN A 10.0.0.2、www.mysite.com IN A 10.0.0.3  
  优点：将负载均衡的工作交给DNS，省掉了网站的管理维护负载均衡服务器的麻烦，同时许多DNS还提供了了基于地理位置的域名解析，即会将域名解析成距离用户地理位置最近的一个服务器地址，这样可加快用户的访问速度，改善性能。  
  缺点：目前的DNS是多级DNS，每级DNS都可能对网站的DNS信息进行缓存，当下线某台服务器后，即使修改了DNS，也需要很长时间才能生效。其次，DNS负载均衡的控制权在域名运营商那里，网站无法做更多的改善和更强大的管理。  
  在实际使用中，大型网站总是部分使用DNS域名解析，利用域名解析作为第一级负载均衡手段。

### 反向代理负载均衡
  反向代理服务器在网络部署上位于WEB服务器之前，其拥有两个网卡，分别拥有内部和外部两套IP地址。在使用中它可以将外部网卡的请求转发到内部网卡连接的网络中的WEB服务器。WEB服务器的响应信息也需要反向代理服务器转发给用户。由于反向代理负载均衡工作在HTTP协议层面，因此也叫作应用层负载均衡。其逻辑架构图如图7所示。
  ![反向代理.jpg](https://weiwei02.coding.me/images/framework/flexible/反向代理.jpg)
  图7 反向代理负载均衡原理

  优点：和反向代理服务器部署在一起，部署简单。  
  缺点：反向代理服务器是所有请求和响应的中转站，其性能可能会成为瓶颈。

### IP负载均衡
  IP负载均衡是在网络层修改目标IP地址来实现负载均衡，其网络架构图如图8所示。  
  ![IP负载均衡.jpg](https://weiwei02.coding.me/images/framework/flexible/IP负载均衡.jpg)
  图8 IP负载均衡原理

  IP负载均衡在处理真是物理WEB服务器的响应数据包时比较复杂。WEB服务器的响应包需要先返回到负载均衡服务器，再由负载均衡服务器转发给用户。响应的转发操作主要有两种实现方式：
  1. 源地址转换（SNAT）：负载均衡服务器在修改目的地址时同时修改源地址，将数据包源地址修改为自身的地址，这样WEB服务器响应会再次回到自身。
  2. 负载均衡服务器同时作为真实服务器的网关设备，这样所有的响应数据都需要先来到负载均衡服务器上，再进行转发。

  优点：在内核进程完成数据分发，较反向代理负载均衡（在应用中分发数据）有更好的处理性能。  
  缺点：所有的请求和回应都需要经过负载均衡服务器，集群的最大响应和吞吐量不得不受制于负载均衡服务器网卡的最大带宽。对于下载或视频服务等需要大量数据传输的手段而言，难以满足要求。

### 数据链路负载均衡
  数据链路负载均衡是在通信协议的数据链路层修改mac地址，来达到负载均衡的目的。负载均衡数据分发过程中不修改IP地址，只修改mac地址，通过配置真是物理服务器集群所有机器虚拟IP和负载均衡服务器IP地址一致，从而达到不修改数据包源地址和目的地址就可以进行数据分发的目的。由于实际处理请求的真是物理服务器IP和数据请求目的IP一致，不需要通过负载均衡服务器进行地址转换，可将响应数据包直接返回给用户浏览器，避免负载均衡服务器网卡带宽成为瓶颈。这种数据三角传输模式又成为直接路由方式（DR）。数据链路负载均衡网络架构如图9所示。  
  ![数据链路.jpg](https://weiwei02.coding.me/images/framework/flexible/数据链路.jpg)
  图7 数据链路负载均衡原理

  使用三角传输模式的数据链路层负载均衡是目前大型网站使用最广泛的一种负载均衡手段。在linux平台上最好的链路层负载均衡的开源产品是LVS（Linux Virtual Server）。

## 负载均衡算法
  负载均衡服务器的实现可分为两个部分：
  1. 根据负载均衡算法和WEB服务器列表计算得到集群中一台WEB服务器的地址。
  2. 将请求发送到该地址所对应的WEB服务器上。

  具体的负载均衡算法通常有以下几种：

### 轮询(Round Robin, RR)
  所有请求依次呗分发到每台应用服务器上，即每台服务器要处理的请求数目都相同，适合所有服务器硬件都相同的场景。

### 加权轮询(Weight Round Robin, WRR)
  根据应用服务器硬件性能的情况，在轮询的基础上，按照权重将请求分发到每个服务器，性能较高的服务器处理更多的请求。

### 随机(Random)
  请求被随机分配到各个应用服务器。随机也可以使用加权。

### 最少连接(Least Connections)
  纪录每个服务器正在处理的连接数，将新到的请求分发到最少连接的服务器上。最少连接最符合负载均衡的定义，同样最少连接算法也能够使用加权。

### 源地址散列(Source Hashing)
  根据请求来源的IP地址进行hash计算，得到应用服务器，这样来自同一个IP地址的请求总在同一个服务器上处理，请求的上下文信息可以存储在这台服务器上，在一个会话周期内重复使用，从而实现会话黏滞。

# 引用

  本文是对可伸缩架构的学习笔记，笔记的内容并非是原创，而是大量参考其它资料。在写作本文的过程中引用了以下资料，为为在此深深谢过以下资料的作者。
  1. 《大型网站技术架构·核心原理与案例分析》 李智慧 2013 电子工业出版社

# 关于
  我的[github](https://github.com/weiwei02/): https://github.com/weiwei02/  
  我相信技术能够改变世界。
